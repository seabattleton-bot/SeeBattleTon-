<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>–ú–æ—Ä—Å–∫–æ–π –±–æ–π ¬∑ –∫–ª–∞—Å—Å–∏–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
        }
        body {
            background: #0a1f44;
            color: white;
            font-family: 'Segoe UI', Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 8px;
        }
        h1 {
            color: #4ec0e9;
            font-size: 26px;
            margin: 5px 0;
        }
        .status {
            background: #16213e;
            padding: 10px;
            border-radius: 20px;
            margin: 10px auto;
            max-width: 350px;
            border: 1px solid #4ec0e9;
            font-size: 18px;
        }
        .board-container {
            background: #0f4c81;
            padding: 15px;
            border-radius: 20px;
            margin: 10px auto;
            max-width: 360px;
            box-shadow: 0 5px 0 #083358;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 2px;
            aspect-ratio: 1;
        }
        .cell {
            background: #2a6f9c;
            border: 1px solid #4ec0e9;
            border-radius: 4px;
            aspect-ratio: 1;
            cursor: pointer;
            transition: 0.1s;
        }
        .cell.setup-ship {
            background: #4a4a4a;
            border-color: #ffd700;
        }
        .cell.enemy:hover {
            background: #ff6b6b;
        }
        .cell.ship {
            background: #4a4a4a;
        }
        .cell.hit {
            background: #ff4444 !important;
            border-color: #ff0000;
        }
        .cell.miss {
            background: #87CEEB !important;
            border-color: #4682B4;
        }
        .ships-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
            margin: 10px 0;
        }
        .ship-item {
            background: #2c3e50;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            border: 1px solid #4ec0e9;
        }
        .ship-item.placed {
            opacity: 0.4;
            text-decoration: line-through;
        }
        .ship-item.current {
            border: 2px solid #ffd700;
            background: #4a4a4a;
            transform: scale(1.02);
        }
        button {
            background: #4ec0e9;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            margin: 8px;
            box-shadow: 0 4px 0 #2a6f9c;
            cursor: pointer;
            transition: 0.1s;
        }
        button:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        button:disabled {
            opacity: 0.5;
            transform: none;
            box-shadow: 0 4px 0 #2a6f9c;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>‚öì –ú–û–†–°–ö–û–ô –ë–û–ô ‚öì</h1>

    <!-- –≠–∫—Ä–∞–Ω —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏ -->
    <div id="setupScreen">
        <div class="status" id="setupStatus">–†–∞—Å—Å—Ç–∞–≤—å –∫–æ—Ä–∞–±–ª–∏</div>
        <div class="ships-list" id="shipsList"></div>
        <div class="board-container">
            <div class="board" id="setupBoard"></div>
        </div>
        <div>
            <button id="randomBtn">üé≤ –°–ª—É—á–∞–π–Ω–æ</button>
            <button id="resetBtn">üîÑ –°–±—Ä–æ—Å</button>
            <button id="startBtn" disabled>‚öîÔ∏è –ù–∞—á–∞—Ç—å –±–æ–π</button>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –±–æ—è -->
    <div id="gameScreen" class="hidden">
        <div class="status" id="gameStatus">–¢–≤–æ–π —Ö–æ–¥!</div>
        <div class="board-container">
            <div class="board" id="enemyBoard"></div>
        </div>
        <div class="board-container">
            <div class="board" id="playerBoard"></div>
        </div>
        <button id="newGameBtn">üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
    </div>

    <script>
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        // ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
        const SHIP_SIZES = [4, 3, 3, 2, 2, 2, 1, 1, 1, 1];
        const SHIP_NAMES = ['–õ–∏–Ω–∫–æ—Ä', '–ö—Ä–µ–π—Å–µ—Ä', '–ö—Ä–µ–π—Å–µ—Ä', '–≠—Å–º–∏–Ω–µ—Ü', '–≠—Å–º–∏–Ω–µ—Ü', '–≠—Å–º–∏–Ω–µ—Ü', '–ö–∞—Ç–µ—Ä', '–ö–∞—Ç–µ—Ä', '–ö–∞—Ç–µ—Ä', '–ö–∞—Ç–µ—Ä'];
        
        // ========== –°–û–°–¢–û–Ø–ù–ò–ï ==========
        let setupBoard = new Array(100).fill(null);
        let placedShips = [];
        let currentShip = 0;
        
        let playerShips = [];
        let enemyShips = [];
        let playerHits = new Array(100).fill(null);
        let enemyHits = new Array(100).fill(null);
        let playerTurn = true;
        let gameOver = false;

        // ========== –†–ê–°–°–¢–ê–ù–û–í–ö–ê ==========
        function renderSetup() {
            let html = '';
            for (let i = 0; i < 100; i++) {
                html += `<div class="cell ${setupBoard[i] === 'ship' ? 'setup-ship' : ''}" onclick="tryPlace(${i})"></div>`;
            }
            document.getElementById('setupBoard').innerHTML = html;

            let listHtml = '';
            for (let i = 0; i < SHIP_SIZES.length; i++) {
                listHtml += `<div class="ship-item ${placedShips.includes(i) ? 'placed' : ''} ${i === currentShip && !placedShips.includes(i) ? 'current' : ''}">${SHIP_NAMES[i]} (${SHIP_SIZES[i]})</div>`;
            }
            document.getElementById('shipsList').innerHTML = listHtml;
            document.getElementById('startBtn').disabled = placedShips.length < 10;
        }

        function canPlace(pos) {
            for (let p of pos) if (setupBoard[p] === 'ship') return false;
            for (let p of pos) {
                let x = p % 10;
                let y = Math.floor(p / 10);
                for (let dy = -1; dy <= 1; dy++) {
                    for (let dx = -1; dx <= 1; dx++) {
                        let nx = x + dx;
                        let ny = y + dy;
                        if (nx >= 0 && nx < 10 && ny >= 0 && ny < 10) {
                            let n = ny * 10 + nx;
                            if (setupBoard[n] === 'ship' && !pos.includes(n)) return false;
                        }
                    }
                }
            }
            return true;
        }

        function tryPlace(index) {
            if (currentShip >= 10 || placedShips.includes(currentShip)) return;
            
            let x = index % 10;
            let y = Math.floor(index / 10);
            let size = SHIP_SIZES[currentShip];
            let positions = [];

            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
            if (x + size <= 10) {
                let pos = [];
                for (let i = 0; i < size; i++) pos.push(y * 10 + (x + i));
                if (canPlace(pos)) positions = pos;
            }

            // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ
            if (positions.length === 0 && y + size <= 10) {
                let pos = [];
                for (let i = 0; i < size; i++) pos.push((y + i) * 10 + x);
                if (canPlace(pos)) positions = pos;
            }

            if (positions.length > 0) {
                positions.forEach(p => setupBoard[p] = 'ship');
                placedShips.push(currentShip);
                while (currentShip < 10 && placedShips.includes(currentShip)) currentShip++;
                renderSetup();
            }
        }

        function randomPlace() {
            setupBoard = new Array(100).fill(null);
            placedShips = [];
            currentShip = 0;

            for (let size of SHIP_SIZES) {
                let placed = false;
                let attempts = 0;
                while (!placed && attempts < 1000) {
                    attempts++;
                    let dir = Math.floor(Math.random() * 2);
                    let x = Math.floor(Math.random() * (dir === 0 ? 10 - size : 10));
                    let y = Math.floor(Math.random() * (dir === 1 ? 10 - size : 10));
                    
                    let pos = [];
                    if (dir === 0) {
                        for (let i = 0; i < size; i++) pos.push(y * 10 + (x + i));
                    } else {
                        for (let i = 0; i < size; i++) pos.push((y + i) * 10 + x);
                    }

                    if (canPlace(pos)) {
                        pos.forEach(p => setupBoard[p] = 'ship');
                        placed = true;
                    }
                }
                if (placed) placedShips.push(currentShip);
                currentShip++;
            }
            currentShip = 10;
            renderSetup();
        }

        // ========== –°–¢–ê–†–¢ –ò–ì–†–´ ==========
        function startGame() {
            // –°–æ–±–∏—Ä–∞–µ–º –∫–æ—Ä–∞–±–ª–∏ –∏–≥—Ä–æ–∫–∞
            playerShips = [];
            let visited = new Array(100).fill(false);
            
            for (let i = 0; i < 100; i++) {
                if (setupBoard[i] === 'ship' && !visited[i]) {
                    let ship = [i];
                    visited[i] = true;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
                    let x = i % 10;
                    let y = Math.floor(i / 10);
                    for (let dx = 1; dx < 4; dx++) {
                        let next = y * 10 + (x + dx);
                        if (x + dx < 10 && setupBoard[next] === 'ship' && !visited[next]) {
                            ship.push(next);
                            visited[next] = true;
                        } else break;
                    }
                    
                    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ, –∏—â–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ
                    if (ship.length === 1) {
                        for (let dy = 1; dy < 4; dy++) {
                            let next = (y + dy) * 10 + x;
                            if (y + dy < 10 && setupBoard[next] === 'ship' && !visited[next]) {
                                ship.push(next);
                                visited[next] = true;
                            } else break;
                        }
                    }
                    playerShips.push(ship);
                }
            }

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ—Ä–∞–±–ª–∏ –≤—Ä–∞–≥–∞
            enemyShips = [];
            let enemyBoard = new Array(100).fill(null);
            
            for (let size of SHIP_SIZES) {
                let placed = false;
                let attempts = 0;
                while (!placed && attempts < 1000) {
                    attempts++;
                    let dir = Math.floor(Math.random() * 2);
                    let x = Math.floor(Math.random() * (dir === 0 ? 10 - size : 10));
                    let y = Math.floor(Math.random() * (dir === 1 ? 10 - size : 10));
                    
                    let pos = [];
                    if (dir === 0) {
                        for (let i = 0; i < size; i++) pos.push(y * 10 + (x + i));
                    } else {
                        for (let i = 0; i < size; i++) pos.push((y + i) * 10 + x);
                    }

                    let valid = true;
                    for (let p of pos) {
                        if (enemyBoard[p] === 'ship') valid = false;
                        let px = p % 10;
                        let py = Math.floor(p / 10);
                        for (let dy = -1; dy <= 1; dy++) {
                            for (let dx = -1; dx <= 1; dx++) {
                                let nx = px + dx;
                                let ny = py + dy;
                                if (nx >= 0 && nx < 10 && ny >= 0 && ny < 10) {
                                    let n = ny * 10 + nx;
                                    if (enemyBoard[n] === 'ship' && !pos.includes(n)) valid = false;
                                }
                            }
                        }
                    }

                    if (valid) {
                        pos.forEach(p => enemyBoard[p] = 'ship');
                        enemyShips.push(pos);
                        placed = true;
                    }
                }
            }

            playerHits = new Array(100).fill(null);
            enemyHits = new Array(100).fill(null);
            playerTurn = true;
            gameOver = false;

            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            renderGame();
        }

        // ========== –ò–ì–†–û–í–û–ô –ü–†–û–¶–ï–°–° ==========
        function renderGame() {
            let playerHtml = '';
            let enemyHtml = '';

            for (let i = 0; i < 100; i++) {
                // –°–≤–æ—ë –ø–æ–ª–µ
                let isPlayerShip = false;
                for (let ship of playerShips) {
                    if (ship.includes(i)) isPlayerShip = true;
                }
                playerHtml += `<div class="cell ${isPlayerShip ? 'ship' : ''} ${enemyHits[i] === 'hit' ? 'hit' : ''} ${enemyHits[i] === 'miss' ? 'miss' : ''}"></div>`;

                // –ü–æ–ª–µ –≤—Ä–∞–≥–∞
                let enemyClass = 'cell enemy';
                if (playerHits[i] === 'hit') enemyClass += ' hit';
                else if (playerHits[i] === 'miss') enemyClass += ' miss';

                let canShoot = playerTurn && !gameOver && !playerHits[i];
                enemyHtml += `<div class="${enemyClass}" onclick="${canShoot ? `shoot(${i})` : ''}"></div>`;
            }

            document.getElementById('playerBoard').innerHTML = playerHtml;
            document.getElementById('enemyBoard').innerHTML = enemyHtml;
        }

        function shoot(index) {
            if (!playerTurn || gameOver || playerHits[index]) return;

            // –ü–æ–ø–∞–¥–∞–Ω–∏–µ?
            let hit = false;
            let shipIndex = -1;
            for (let i = 0; i < enemyShips.length; i++) {
                if (enemyShips[i].includes(index)) {
                    hit = true;
                    shipIndex = i;
                    break;
                }
            }

            playerHits[index] = hit ? 'hit' : 'miss';
            renderGame();

            if (hit) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–±–∏—Ç –ª–∏ –∫–æ—Ä–∞–±–ª—å
                let ship = enemyShips[shipIndex];
                let allHit = true;
                for (let cell of ship) {
                    if (playerHits[cell] !== 'hit') allHit = false;
                }

                if (allHit) {
                    // –û—Ç–º–µ—á–∞–µ–º –∫–ª–µ—Ç–∫–∏ –≤–æ–∫—Ä—É–≥
                    for (let cell of ship) {
                        let x = cell % 10;
                        let y = Math.floor(cell / 10);
                        for (let dy = -1; dy <= 1; dy++) {
                            for (let dx = -1; dx <= 1; dx++) {
                                let nx = x + dx;
                                let ny = y + dy;
                                if (nx >= 0 && nx < 10 && ny >= 0 && ny < 10) {
                                    let n = ny * 10 + nx;
                                    if (!playerHits[n]) {
                                        playerHits[n] = 'miss';
                                    }
                                }
                            }
                        }
                    }
                    enemyShips.splice(shipIndex, 1);
                    renderGame();

                    if (enemyShips.length === 0) {
                        gameOver = true;
                        document.getElementById('gameStatus').innerText = 'üèÜ –¢—ã –ø–æ–±–µ–¥–∏–ª!';
                        return;
                    }
                }
            }

            // –•–æ–¥ –≤—Ä–∞–≥–∞
            playerTurn = false;
            document.getElementById('gameStatus').innerText = '–•–æ–¥ –≤—Ä–∞–≥–∞...';
            setTimeout(enemyMove, 500);
        }

        function enemyMove() {
            if (gameOver) return;

            // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –Ω–µ–ø–æ–¥–±–∏—Ç—É—é –∫–ª–µ—Ç–∫—É
            let available = [];
            for (let i = 0; i < 100; i++) {
                if (!enemyHits[i]) available.push(i);
            }
            let index = available[Math.floor(Math.random() * available.length)];

            // –ü–æ–ø–∞–¥–∞–Ω–∏–µ?
            let hit = false;
            let shipIndex = -1;
            for (let i = 0; i < playerShips.length; i++) {
                if (playerShips[i].includes(index)) {
                    hit = true;
                    shipIndex = i;
                    break;
                }
            }

            enemyHits[index] = hit ? 'hit' : 'miss';
            renderGame();

            if (hit) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–±–∏—Ç –ª–∏ –∫–æ—Ä–∞–±–ª—å
                let ship = playerShips[shipIndex];
                let allHit = true;
                for (let cell of ship) {
                    if (enemyHits[cell] !== 'hit') allHit = false;
                }

                if (allHit) {
                    // –û—Ç–º–µ—á–∞–µ–º –∫–ª–µ—Ç–∫–∏ –≤–æ–∫—Ä—É–≥
                    for (let cell of ship) {
                        let x = cell % 10;
                        let y = Math.floor(cell / 10);
                        for (let dy = -1; dy <= 1; dy++) {
                            for (let dx = -1; dx <= 1; dx++) {
                                let nx = x + dx;
                                let ny = y + dy;
                                if (nx >= 0 && nx < 10 && ny >= 0 && ny < 10) {
                                    let n = ny * 10 + nx;
                                    if (!enemyHits[n]) {
                                        enemyHits[n] = 'miss';
                                    }
                                }
                            }
                        }
                    }
                    playerShips.splice(shipIndex, 1);
                    renderGame();

                    if (playerShips.length === 0) {
                        gameOver = true;
                        document.getElementById('gameStatus').innerText = 'üíî –¢—ã –ø—Ä–æ–∏–≥—Ä–∞–ª...';
                        return;
                    }
                }
            }

            playerTurn = true;
            document.getElementById('gameStatus').innerText = '–¢–≤–æ–π —Ö–æ–¥';
        }

        function newGame() {
            document.getElementById('setupScreen').classList.remove('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            setupBoard = new Array(100).fill(null);
            placedShips = [];
            currentShip = 0;
            renderSetup();
        }

        // ========== –ö–ù–û–ü–ö–ò ==========
        document.getElementById('randomBtn').onclick = randomPlace;
        document.getElementById('resetBtn').onclick = () => {
            setupBoard = new Array(100).fill(null);
            placedShips = [];
            currentShip = 0;
            renderSetup();
        };
        document.getElementById('startBtn').onclick = startGame;
        document.getElementById('newGameBtn').onclick = newGame;

        // –ó–∞–ø—É—Å–∫
        renderSetup();
    </script>
</body>
</html>
