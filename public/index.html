import logging
from telegram import Update
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext
import random

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')

# --- Классы для логики игры ---

class BattleShipBoard:
    def __init__(self):
        self.size = 10
        self.board = [['~'] * self.size for _ in range(self.size)]
        self.ships = []  # [((x1, y1), (x2, y2)), ...]
        self.busy = set()
        self.ship_cells = set()
        self.marked = set()
    
    def place_ships_auto(self):
        """Автоматическая расстановка кораблей"""
        ships_len = [4] + [3]*2 + [2]*3 + [1]*4
        tries = 0
        for L in ships_len:
            while True:
                if tries > 1000:
                    raise Exception("Не могу расставить корабли")
                orientation = random.choice(['h', 'v'])
                if orientation == 'h':
                    x = random.randint(0, self.size - L)
                    y = random.randint(0, self.size - 1)
                    ship = [(x+i, y) for i in range(L)]
                else:
                    x = random.randint(0, self.size - 1)
                    y = random.randint(0, self.size - L)
                    ship = [(x, y+i) for i in range(L)]
                if all((cx, cy) not in self.busy for cx, cy in ship):
                    border = set()
                    for cx, cy in ship:
                        for dx in [-1, 0, 1]:
                            for dy in [-1, 0, 1]:
                                nx, ny = cx+dx, cy+dy
                                if 0 <= nx < self.size and 0 <= ny < self.size:
                                    border.add((nx, ny))
                    if all(b not in self.busy for b in border):
                        self.ships.append((ship[0], ship[-1]))
                        for cell in ship:
                            self.ship_cells.add(cell)
                        self.busy.update(border)
                        break 
                tries += 1

    def receive_shot(self, x, y):
        if not (0 <= x < self.size and 0 <= y < self.size):
            return 'error'
        if (x, y) in self.marked:
            return 'error'
        self.marked.add((x, y))
        if (x, y) in self.ship_cells:
            for (start, end) in self.ships:
                ship_cells = []
                if start[0] == end[0]:  # Вертикальный
                    xs = start[0]
                    for yy in range(start[1], end[1]+1):
                        ship_cells.append((xs, yy))
                else:
                    ys = start[1]
                    for xx in range(start[0], end[0]+1):
                        ship_cells.append((xx, ys))
                if (x, y) in ship_cells:
                    if all(c in self.marked for c in ship_cells):
                        for cx, cy in ship_cells:
                            for dx in [-1, 0, 1]:
                                for dy in [-1, 0, 1]:
                                    nx, ny = cx+dx, cy+dy
                                    if (0 <= nx < self.size and 0 <= ny < self.size
                                        and (nx, ny) not in self.marked
                                        and (nx, ny) not in self.ship_cells):
                                        self.marked.add((nx, ny))
                        return 'kill'
                    else:
                        return 'hit'
        return 'miss'

    def display(self, show_ships=False):
        s = '  ' + ' '.join('АБВГДЕЖЗИК'[i] for i in range(self.size)) + '\n'
        for y in range(self.size):
            s += f"{y+1:2}"
            for x in range(self.size):
                cell = (x, y)
                if cell in self.marked:
                    if cell in self.ship_cells:
                        s += " ☒"
                    else:
                        s += " ·"
                elif show_ships and cell in self.ship_cells:
                    s += " ■"
                else:
                    s += " ~"
            s += '\n'
        return s

    def is_defeated(self):
        return all(cell in self.marked for cell in self.ship_cells)

# --- Telegram Bot ---
user_games = {}

def start(update: Update, context: CallbackContext):
    chat_id = update.message.chat_id
    user_games[chat_id] = {
        'player': BattleShipBoard(),
        'bot': BattleShipBoard(),
        'state': 'prepping',
    }
    user_games[chat_id]['player'].place_ships_auto()
    user_games[chat_id]['bot'].place_ships_auto()
    update.message.reply_text(
        "Ваше поле (авто-расстановка):\n" +
        user_games[chat_id]['player'].display(show_ships=True) +
        "Ваш ход! Напишите например: А5"
    )
    user_games[chat_id]['state'] = 'playing'

def player_move(update: Update, context: CallbackContext):
    chat_id = update.message.chat_id
    if chat_id not in user_games or user_games[chat_id]['state'] != 'playing':
        update.message.reply_text('Введите /start для начала игры.')
        return
    text = update.message.text.strip().upper()
    if len(text) < 2:
        update.message.reply_text('Ход в формате: Б3')
        return
    x = 'АБВГДЕЖЗИК'.find(text[0])
    try:
        y = int(text[1:]) - 1
    except:
        update.message.reply_text('Ход в формате: Б3')
        return
    if x == -1 or not (0 <= y < 10):
        update.message.reply_text('Некорректные координаты, напишите например: Д4')
        return
    res = user_games[chat_id]['bot'].receive_shot(x, y)
    msg = f"Вы стреляете по: {text} — "
    if res == 'miss':
        msg += "мимо.\n"
    elif res == 'hit':
        msg += "попадание!\n"
    elif res == 'kill':
        msg += "корабль потоплен!"
    elif res == 'error':
        update.message.reply_text("Вы уже стреляли сюда!")
        return
    if user_games[chat_id]['bot'].is_defeated():
        msg += "\nВы победили!"
        update.message.reply_text(msg)
        user_games[chat_id]['state'] = 'done'
        return
    update.message.reply_text(
        msg + "\nПоле противника:\n" +
        user_games[chat_id]['bot'].display()
    )
    while True:
        bx, by = random.randint(0, 9), random.randint(0, 9)
        if (bx, by) not in user_games[chat_id]['player'].marked:
            break
    res = user_games[chat_id]['player'].receive_shot(bx, by)
    pos = f"{'АБВГДЕЖЗИК'[bx]}{by+1}"
    msg = f"\nБот стреляет по: {pos} — "
    if res == 'miss':
        msg += "мимо."
    elif res == 'hit':
        msg += "попадание!"
    elif res == 'kill':
        msg += "корабль потоплен!"
    if user_games[chat_id]['player'].is_defeated():
        msg += "\nПобедил бот!"
        update.message.reply_text(msg)
        user_games[chat_id]['state'] = 'done'
        return
    update.message.reply_text(
        msg +
        "\nВаше поле:\n" +
        user_games[chat_id]['player'].display(show_ships=True) +
        "\nВаш ход! (например: Ж7)"
    )

def main():
    import os
      
